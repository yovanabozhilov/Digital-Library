{% load static %}
<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <title>{{ book.title }} - –ß–µ—Ç–µ–Ω–µ</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/read-book.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</head>
<body class="welcome read-book-page">
<header class="read-book-header">
    <img src="{% static 'images/logo.png' %}" class="read-book-logo" alt="Logo">
    <nav class="read-book-nav">
        <a href="{% url 'main' %}">–û—Å–Ω–æ–≤–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞</a>
        <a href="{% url 'my_added_books' %}">–ú–æ—è—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</a>
        <a href="{% url 'profile' %}">–ü—Ä–æ—Ñ–∏–ª</a>
        <a href="{% url 'logout' %}">–ò–∑—Ö–æ–¥</a>
    </nav>
</header>

<main class="read-book-main">
    <div id="reader-wrapper">
        <h2>{{ book.title }}</h2>

        <div id="pdf-container">
            <canvas id="pdf-canvas"></canvas>
            <div class="page-controls">
                <button id="prev-page">–ü—Ä–µ–¥–∏—à–Ω–∞</button>
                <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞: <span id="page-num"></span> / <span id="page-count"></span></span>
                <button id="next-page">–°–ª–µ–¥–≤–∞—â–∞</button>
            </div>
        </div>

        <div id="highlight-controls">
            <button onclick="saveHighlight()">–î–æ–±–∞–≤–∏ –∫—ä–º —Ü–∏—Ç–∞—Ç–∏</button>
            <button onclick="addNote()">–î–æ–±–∞–≤–∏ –±–µ–ª–µ–∂–∫–∞</button>

            <input type="text" id="lookup-word" placeholder="–í—ä–≤–µ–¥–∏ –¥—É–º–∞ –∑–∞ —Ç—ä—Ä—Å–µ–Ω–µ">
            <button onclick="lookupWord()">üîç –¢—ä—Ä—Å–∏</button>
        </div>

        <div id="definition-result" class="definition-box"></div>

        <div class="quotes-box">
            <h3>üìå –ó–∞–ø–∞–∑–µ–Ω–∏ —Ü–∏—Ç–∞—Ç–∏</h3>
            {% if quotes %}
                <ul>
                    {% for q in quotes %}
                        <li>
                            <em>—Å—Ç—Ä. {{ q.page }}:</em> {{ q.quote_text }}
                            <button onclick="deleteQuote('{{ q.id }}')" class="small-action-button">üóëÔ∏è</button>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>–í—Å–µ –æ—â–µ –Ω—è–º–∞—à –∑–∞–ø–∞–∑–µ–Ω–∏ —Ü–∏—Ç–∞—Ç–∏.</p>
            {% endif %}
        </div>

        <div class="notes-box">
            <h3>üìù –ë–µ–ª–µ–∂–∫–∏</h3>
            {% if notes %}
                <ul>
                    {% for n in notes %}
                        <li>
                            <em>—Å—Ç—Ä. {{ n.page }}:</em> {{ n.content }}
                            <button onclick="deleteNote('{{ n.id }}')" class="small-action-button">üóëÔ∏è</button>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>–í—Å–µ –æ—â–µ –Ω—è–º–∞—à –±–µ–ª–µ–∂–∫–∏.</p>
            {% endif %}
        </div>
    </div>
</main>

<footer class="read-book-footer">
    Digital Library ¬© 2025
</footer>

<script>
    const url = "{{ book.ebookfile.file.url }}";
    let pdfDoc = null,
        pageNum = localStorage.getItem("lastPage_{{ book.id }}") ? parseInt(localStorage.getItem("lastPage_{{ book.id }}")) : 1,
        pageRendering = false,
        pageNumPending = null,
        scale = 1.5,
        canvas = document.getElementById('pdf-canvas'),
        ctx = canvas.getContext('2d');

    function renderPage(num) {
        pageRendering = true;
        pdfDoc.getPage(num).then(function(page) {
            const viewport = page.getViewport({ scale: scale });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            const renderTask = page.render(renderContext);
            renderTask.promise.then(function() {
                pageRendering = false;
                document.getElementById('page-num').textContent = num;
                localStorage.setItem("lastPage_{{ book.id }}", num);
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
        });
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    function onPrevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }

    function onNextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }

    function saveHighlight() {
    const quote = prompt("–í—ä–≤–µ–¥–∏ —Ü–∏—Ç–∞—Ç –∑–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ " + pageNum + ":");
    if (quote) {
        fetch("/save_quote/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": '{{ csrf_token }}'
            },
            body: JSON.stringify({
                book_id: '{{ book.id }}',
                text: quote,
                page: pageNum
            })
        }).then(response => {
            if (response.ok) {
                alert("–¶–∏—Ç–∞—Ç—ä—Ç –µ –∑–∞–ø–∞–∑–µ–Ω!");
                location.reload();
            } else {
                alert("–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ.");
            }
        });
    }
}

    function addNote() {
    const note = prompt("–í—ä–≤–µ–¥–∏ –±–µ–ª–µ–∂–∫–∞ –∑–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ " + pageNum + ":");
    if (note) {
        fetch("/save_note/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": '{{ csrf_token }}'
            },
            body: JSON.stringify({
                book_id: '{{ book.id }}',
                content: note,     
                page: pageNum
            })
        }).then(response => {
            if (response.ok) {
                alert("–ë–µ–ª–µ–∂–∫–∞—Ç–∞ –µ –∑–∞–ø–∞–∑–µ–Ω–∞!");
                location.reload();  
            } else {
                alert("–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ.");
            }
        });
    }
}

function deleteQuote(id) {
    if (confirm("–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏, —á–µ –∏—Å–∫–∞—à –¥–∞ –∏–∑—Ç—Ä–∏–µ—à —Ç–æ–∑–∏ —Ü–∏—Ç–∞—Ç?")) {
        fetch("/delete_quote/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": '{{ csrf_token }}'
            },
            body: JSON.stringify({ id: id })
        }).then(res => res.json()).then(data => {
            if (data.status === "ok") {
                location.reload();
            } else {
                alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ü–∏—Ç–∞—Ç.");
            }
        });
    }
}

function deleteNote(id) {
    if (confirm("–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏, —á–µ –∏—Å–∫–∞—à –¥–∞ –∏–∑—Ç—Ä–∏–µ—à —Ç–∞–∑–∏ –±–µ–ª–µ–∂–∫–∞?")) {
        fetch("/delete_note/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": '{{ csrf_token }}'
            },
            body: JSON.stringify({ id: id })
        }).then(res => res.json()).then(data => {
            if (data.status === "ok") {
                location.reload();
            } else {
                alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –±–µ–ª–µ–∂–∫–∞.");
            }
        });
    }
}

    document.getElementById('prev-page').addEventListener('click', onPrevPage);
    document.getElementById('next-page').addEventListener('click', onNextPage);

    pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
        pdfDoc = pdfDoc_;
        document.getElementById('page-count').textContent = pdfDoc.numPages;
        renderPage(pageNum);
    });

window.lookupWord = function () {
        const input = document.getElementById("lookup-word");
        let word = input.value.trim();

        const resultBox = document.getElementById("definition-result");
        resultBox.classList.remove("visible"); 
        resultBox.innerHTML = ""; 

        if (!word) {
            word = window.getSelection().toString().trim();
            input.value = word;
        }

        if (!word) return;

        resultBox.innerHTML = "<em>–ü—Ä–µ–≤–µ–∂–¥–∞–º –∏ —Ç—ä—Ä—Å—è –¥–µ—Ñ–∏–Ω–∏—Ü–∏—è...</em>";
        resultBox.classList.add("visible");

        fetch(`/translate_define/?word=${encodeURIComponent(word)}`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    resultBox.innerHTML = `<em>${data.error}</em>`;
                    return;
                }

                let html = "";
                const isCyrillic = /^[\u0400-\u04FF\s]+$/.test(data.original);

                if (isCyrillic) {
                    html += `<h3>‚Äû${data.original}‚Äú</h3>`;
                } else {
                    html += `<h3>‚Äû${data.original}‚Äú ‚Üí <strong>${data.translated}</strong></h3>`;
                }

                const partMap = {
                    noun: "(—Å—ä—â.)",
                    verb: "(–≥–ª.)",
                    adjective: "(–ø—Ä–∏–ª.)",
                    adverb: "(–Ω–∞—Ä.)",
                    pronoun: "(–º–µ—Å—Ç–æ–∏–º.)",
                    conjunction: "(—Å—ä—é–∑)",
                    preposition: "(–ø—Ä–µ–¥–ª.)",
                    interjection: "(–º–µ–∂–¥.)",
                    determiner: "(–æ–ø—Ä.)",
                    exclamation: "(–≤—ä–∑–∫–ª.)"
                };

                if (data.definitions && Object.keys(data.definitions).length > 0) {
                    for (const part in data.definitions) {
                        const translatedPart = partMap[part] || part;
                        html += `<h4>${translatedPart}</h4><ul>`;
                        data.definitions[part].forEach(def => {
                            html += `<li>${def}</li>`;
                        });
                        html += `</ul>`;
                    }
                } else {
                    html += `<p><em>${data.message || "–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∞ –¥–µ—Ñ–∏–Ω–∏—Ü–∏—è."}</em></p>`;
                }

                resultBox.innerHTML = html;
                resultBox.classList.add("visible");
            })
            .catch(err => {
                console.error("–ì—Ä–µ—à–∫–∞:", err);
                resultBox.innerHTML = `<em>–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—è–≤–∫–∞—Ç–∞: ${err.message}</em>`;
                resultBox.classList.add("visible");
            });
    };


let startTime = Date.now();
let startPage = pageNum;

window.addEventListener("beforeunload", function () {
    let endTime = Date.now();
    let durationMinutes = Math.round((endTime - startTime) / 60000);
    let pagesRead = Math.abs(pageNum - startPage) + 1;

    if (durationMinutes > 0) {
        fetch("{% url 'save_reading_duration' book.id %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                duration_minutes: durationMinutes,
                pages_read: pagesRead
            })
        });
    }
});
</script>
</body>
</html>